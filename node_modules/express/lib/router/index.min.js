/**
 * Module dependencies.
 */function Router(e){e=e||{};var t=this;this.map={};this.params={};this._params=[];this.caseSensitive=e.caseSensitive;this.strict=e.strict;this.middleware=function(n,r,i){t._dispatch(n,r,i)}}var Route=require("./route"),utils=require("../utils"),methods=require("methods"),debug=require("debug")("express:router"),parseUrl=require("parseurl");exports=module.exports=Router;Router.prototype.param=function(e,t){if("function"==typeof e){this._params.push(e);return}var n=this._params,r=n.length,i;for(var s=0;s<r;++s)if(i=n[s](e,t))t=i;if("function"!=typeof t)throw new Error("invalid param() call for "+e+", got "+t);(this.params[e]=this.params[e]||[]).push(t);return this};Router.prototype._dispatch=function(e,t,n){var r=this.params,i=this;debug("dispatching %s %s (%s)",e.method,e.url,e.originalUrl);(function s(o,u){function d(t){s(e._route_index+1,t)}function v(t){f=0;p=h[o++];l=p&&e.params[p.name];a=p&&r[p.name];try{if("route"==t)d();else if(t){o=0;g(t)}else if(a&&undefined!==l)m();else if(p)v();else{o=0;g()}}catch(t){v(t)}}function m(n){var r=a[f++];if(n||!r)return v(n);r(e,t,m,l,p.name)}function g(n){var r=c.callbacks[o++];try{if("route"==n)d();else if(n&&r){if(r.length<4)return g(n);r(n,e,t,g)}else if(r){if(r.length<4)return r(e,t,g);g()}else d(n)}catch(n){g(n)}}var a,f=0,l,c,h,p;e.route=c=i.matchRequest(e,o);if(!c&&"OPTIONS"==e.method)return i._options(e,t,n);if(!c)return n(u);debug("matched %s %s",c.method,c.path);e.params=c.params;h=c.keys;o=0;v(u)})(0)};Router.prototype._options=function(e,t,n){var r=parseUrl(e).pathname,i=this._optionsFor(r).join(",");if(!i)return n();t.set("Allow",i).send(i)};Router.prototype._optionsFor=function(t){var n=[];for(var r=0;r<methods.length;r++){var i=methods[r];if(i==="options")continue;var s=this.map[i];!s&&i==="head"&&(s=this.map.get);if(!s)continue;for(var o=0;o<s.length;o++)if(s[o].match(t)){n.push(i.toUpperCase());break}}return n.sort()};Router.prototype.matchRequest=function(e,t,n){var r=e.method.toLowerCase(),i=parseUrl(e),s=i.pathname,o=this.map,t=t||0,u;if(!n&&"head"==r){u=this.matchRequest(e,t,!0);if(u)return u;r="get"}if(o=o[r])for(var a=o.length;t<a;++t){u=o[t];if(u.match(s)){e._route_index=t;return u}}};Router.prototype.match=function(e,t,n,r){var i={method:e,url:t};return this.matchRequest(i,n,r)};Router.prototype.route=function(e,t,n){var e=e.toLowerCase(),n=utils.flatten([].slice.call(arguments,2));if(!t)throw new Error("Router#"+e+"() requires a path");n.forEach(function(t){if("function"==typeof t)return;var n={}.toString.call(t),r="."+e+"() requires callback functions but got a "+n;throw new Error(r)});debug("defined %s %s",e,t);var r=new Route(e,t,n,{sensitive:this.caseSensitive,strict:this.strict});(this.map[e]=this.map[e]||[]).push(r);return this};Router.prototype.all=function(e){var t=this,n=[].slice.call(arguments);methods.forEach(function(e){t.route.apply(t,[e].concat(n))});return this};methods.forEach(function(e){Router.prototype[e]=function(t){var n=[e].concat([].slice.call(arguments));this.route.apply(this,n);return this}});
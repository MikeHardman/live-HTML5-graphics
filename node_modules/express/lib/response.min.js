/*!
 * express
 * Copyright(c) 2009-2013 TJ Holowaychuk
 * Copyright(c) 2014-2015 Douglas Christopher Wilson
 * MIT Licensed
 *//**
 * Module dependencies.
 * @api private
 */var contentDisposition=require("content-disposition"),deprecate=require("depd")("express"),escapeHtml=require("escape-html"),merge=require("utils-merge"),parseUrl=require("parseurl"),vary=require("vary"),http=require("http"),path=require("path"),connect=require("connect"),sign=require("cookie-signature").sign,normalizeType=require("./utils").normalizeType,normalizeTypes=require("./utils").normalizeTypes,setCharset=require("./utils").setCharset,statusCodes=http.STATUS_CODES,cookie=require("cookie"),send=require("send"),mime=connect.mime,resolve=require("url").resolve,basename=path.basename,extname=path.extname,res=module.exports={__proto__:http.ServerResponse.prototype};res.status=function(e){this.statusCode=e;return this};res.links=function(e){var t=this.get("Link")||"";t&&(t+=", ");return this.set("Link",t+Object.keys(e).map(function(t){return"<"+e[t]+'>; rel="'+t+'"'}).join(", "))};res.send=function(e){var t=this.req,n,r,i,s=this.app;if(2==arguments.length)if("number"!=typeof e&&"number"==typeof arguments[1])this.statusCode=arguments[1];else{this.statusCode=e;e=arguments[1]}if(typeof e=="number"&&arguments.length===1){this.get("Content-Type")||this.type("txt");this.statusCode=e;e=http.STATUS_CODES[e]}switch(typeof e){case"string":if(!this.get("Content-Type")){this.charset=this.charset||"utf-8";this.type("html")}break;case"boolean":case"number":case"object":if(null==e)e="";else{if(!Buffer.isBuffer(e))return this.json(e);this.get("Content-Type")||this.type("bin")}}if("string"==typeof e){r="utf8";n=this.get("Content-Type");"string"==typeof n&&this.set("Content-Type",setCharset(n,"utf-8"))}if(undefined!==e&&!this.get("Content-Length")){i=Buffer.isBuffer(e)?e.length:Buffer.byteLength(e,r);this.set("Content-Length",i)}var o,u=i!==undefined&&s.get("etag fn");typeof u=="function"&&!this.get("ETag")&&(o=u(e,r))&&this.set("ETag",o);t.fresh&&(this.statusCode=304);if(204==this.statusCode||304==this.statusCode){this.removeHeader("Content-Type");this.removeHeader("Content-Length");this.removeHeader("Transfer-Encoding");e=""}t.method==="HEAD"?this.end():this.end(e,r);return this};res.json=function(e){if(2==arguments.length)if("number"==typeof arguments[1]){this.statusCode=arguments[1];typeof e=="number"?deprecate("res.json(obj, status): Use res.json(status, obj) instead"):deprecate("res.json(num, status): Use res.status(status).json(num) instead")}else{this.statusCode=e;e=arguments[1]}var t=this.app,n=t.get("json replacer"),r=t.get("json spaces"),i=JSON.stringify(e,n,r);this.charset=this.charset||"utf-8";this.get("Content-Type")||this.set("Content-Type","application/json");return this.send(i)};res.jsonp=function(e){if(2==arguments.length)if("number"==typeof arguments[1]){this.statusCode=arguments[1];typeof e=="number"?deprecate("res.jsonp(obj, status): Use res.jsonp(status, obj) instead"):deprecate("res.jsonp(num, status): Use res.status(status).jsonp(num) instead")}else{this.statusCode=e;e=arguments[1]}var t=this.app,n=t.get("json replacer"),r=t.get("json spaces"),i=JSON.stringify(e,n,r),s=this.req.query[t.get("jsonp callback name")];if(!this.get("Content-Type")){this.charset="utf-8";this.set("X-Content-Type-Options","nosniff");this.set("Content-Type","application/json")}Array.isArray(s)&&(s=s[0]);if(typeof s=="string"&&s.length!==0){this.charset="utf-8";this.set("X-Content-Type-Options","nosniff");this.set("Content-Type","text/javascript");s=s.replace(/[^\[\]\w$.]/g,"");i=i.replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029");i="/**/ typeof "+s+" === 'function' && "+s+"("+i+");"}return this.send(i)};res.sendfile=function(e,t,n){function u(e){if(o)return;o=!0;f();r.headersSent||r.removeHeader("Content-Disposition");if(n)return n(e);if(r.headersSent)return;s(e)}function a(e){if(o)return;f();n&&e.on("end",n)}function f(){i.socket.removeListener("error",u)}var r=this,i=r.req,s=this.req.next,t=t||{},o;if("function"==typeof t){n=t;t={}}i.socket.on("error",u);var l=send(i,e,t);l.on("error",u);l.on("directory",s);l.on("stream",a);l.pipe(this);this.on("finish",f)};res.download=function(t,n,r){if(typeof n=="function"){r=n;n=null}n=n||t;this.set("Content-Disposition",contentDisposition(n));return this.sendfile(t,r)};res.contentType=res.type=function(e){return this.set("Content-Type",~e.indexOf("/")?e:mime.lookup(e))};res.format=function(e){var t=this.req,n=t.next,r=e.default;r&&delete e.default;var i=Object.keys(e),s=t.accepts(i);this.vary("Accept");if(s){var o=normalizeType(s).value,u=mime.charsets.lookup(o);u&&(o+="; charset="+u);this.set("Content-Type",o);e[s](t,this,n)}else if(r)r();else{var a=new Error("Not Acceptable");a.status=406;a.types=normalizeTypes(i).map(function(e){return e.value});n(a)}return this};res.attachment=function(t){t&&this.type(extname(t));this.set("Content-Disposition",contentDisposition(t));return this};res.set=res.header=function(e,t){if(2==arguments.length){Array.isArray(t)?t=t.map(String):t=String(t);this.setHeader(e,t)}else for(var n in e)this.set(n,e[n]);return this};res.get=function(e){return this.getHeader(e)};res.clearCookie=function(e,t){var n={expires:new Date(1),path:"/"};return this.cookie(e,"",t?merge(n,t):n)};res.cookie=function(e,t,n){n=merge({},n);var r=this.req.secret,i=n.signed;if(i&&!r)throw new Error('connect.cookieParser("secret") required for signed cookies');"number"==typeof t&&(t=t.toString());"object"==typeof t&&(t="j:"+JSON.stringify(t));i&&(t="s:"+sign(t,r));if("maxAge"in n){n.expires=new Date(Date.now()+n.maxAge);n.maxAge/=1e3}null==n.path&&(n.path="/");this.set("Set-Cookie",cookie.serialize(e,String(t),n));return this};res.location=function(e){var t=this.app,n=this.req,r;"back"==e&&(e=n.get("Referrer")||"/");if(!~e.indexOf("://")&&0!=e.indexOf("//"))if("."==e[0]){r=parseUrl.original(n).pathname;r+="/"==r[r.length-1]?"":"/";e=resolve(r,e)}else if("/"!=e[0]){r=t.path();e=r+"/"+e}this.set("Location",e);return this};res.redirect=function(e){var t="HEAD"==this.req.method,n=302,r;if(2==arguments.length)if("number"==typeof e){n=e;e=arguments[1]}else{deprecate("res.redirect(url, status): Use res.redirect(status, url) instead");n=arguments[1]}this.location(e);e=this.get("Location");this.format({text:function(){r=statusCodes[n]+". Redirecting to "+encodeURI(e)},html:function(){var t=escapeHtml(e);r="<p>"+statusCodes[n]+'. Redirecting to <a href="'+t+'">'+t+"</a></p>"},"default":function(){r=""}});this.statusCode=n;this.set("Content-Length",Buffer.byteLength(r));this.end(t?null:r)};res.vary=function(e){if(!e)return this;if(Array.isArray(e)&&!e.length)return this;vary(this,e);return this};res.render=function(e,t,n){var r=this,t=t||{},i=this.req,s=i.app;"function"==typeof t&&(n=t,t={});t._locals=r.locals;n=n||function(e,t){if(e)return i.next(e);r.send(t)};s.render(e,t,n)};
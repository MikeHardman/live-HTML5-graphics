/*!
 * express
 * Copyright(c) 2009-2013 TJ Holowaychuk
 * Copyright(c) 2013 Roman Shtylman
 * Copyright(c) 2014-2015 Douglas Christopher Wilson
 * MIT Licensed
 *//**
 * Module dependencies.
 * @api private
 */var connect=require("connect"),Router=require("./router"),methods=require("methods"),middleware=require("./middleware"),debug=require("debug")("express:application"),locals=require("./utils").locals,compileETag=require("./utils").compileETag,compileTrust=require("./utils").compileTrust,View=require("./view"),http=require("http"),deprecate=require("depd")("express"),merge=require("utils-merge"),app=exports=module.exports={},trustProxyDefaultSymbol="@@symbol:trust_proxy_default";app.init=function(){this.cache={};this.settings={};this.engines={};this.defaultConfiguration()};app.defaultConfiguration=function(){this.enable("x-powered-by");this.set("etag","weak");var e=process.env.NODE_ENV||"development";this.set("env",e);this.set("subdomain offset",2);this.set("trust proxy",!1);Object.defineProperty(this.settings,trustProxyDefaultSymbol,{configurable:!0,value:!0});debug("booting in %s mode",e);this.use(connect.query());this.use(middleware.init(this));this.on("mount",function(t){if(this.settings[trustProxyDefaultSymbol]===!0&&typeof t.settings["trust proxy fn"]=="function"){delete this.settings["trust proxy"];delete this.settings["trust proxy fn"]}this.request.__proto__=t.request;this.response.__proto__=t.response;this.engines.__proto__=t.engines;this.settings.__proto__=t.settings});this._router=new Router(this);this.routes=this._router.map;this.__defineGetter__("router",function(){this._usedRouter=!0;this._router.caseSensitive=this.enabled("case sensitive routing");this._router.strict=this.enabled("strict routing");return this._router.middleware});this.locals=locals(this);this.locals.settings=this.settings;this.set("view",View);this.set("views",process.cwd()+"/views");this.set("jsonp callback name","callback");e==="development"&&this.set("json spaces",2);e==="production"&&this.enable("view cache")};app.use=function(e,t){var n;"string"!=typeof e&&(t=e,e="/");t.handle&&t.set&&(n=t);if(n){n.route=e;t=function(e,t,r){var i=e.app;n.handle(e,t,function(n){e.__proto__=i.request;t.__proto__=i.response;r(n)})}}connect.proto.use.call(this,e,t);if(n){n.parent=this;n.emit("mount",this)}return this};app.engine=function(e,t){if("function"!=typeof t)throw new Error("callback function required");"."!=e[0]&&(e="."+e);this.engines[e]=t;return this};app.param=function(e,t){var n=this,r=[].slice.call(arguments,1);if(Array.isArray(e))e.forEach(function(e){r.forEach(function(t){n.param(e,t)})});else if("function"==typeof e)this._router.param(e);else{":"==e[0]&&(e=e.substr(1));r.forEach(function(t){n._router.param(e,t)})}return this};app.set=function(e,t){if(arguments.length===1)return this.settings[e];this.settings[e]=t;switch(e){case"etag":debug("compile etag %s",t);this.set("etag fn",compileETag(t));break;case"trust proxy":debug("compile trust proxy %s",t);this.set("trust proxy fn",compileTrust(t));Object.defineProperty(this.settings,trustProxyDefaultSymbol,{configurable:!0,value:!1})}return this};app.path=function(){return this.parent?this.parent.path()+this.route:""};app.enabled=function(e){return!!this.set(e)};app.disabled=function(e){return!this.set(e)};app.enable=function(e){return this.set(e,!0)};app.disable=function(e){return this.set(e,!1)};app.configure=function(e,t){var n="all",r=[].slice.call(arguments);t=r.pop();r.length&&(n=r);("all"==n||~n.indexOf(this.settings.env))&&t.call(this);return this};app.configure=deprecate.function(app.configure,"app.configure: Check app.get('env') in an if statement");methods.forEach(function(e){app[e]=function(t){if("get"==e&&1==arguments.length)return this.set(t);this._usedRouter||this.use(this.router);this._router[e].apply(this._router,arguments);return this}});app.all=function(e){var t=arguments;methods.forEach(function(e){app[e].apply(this,t)},this);return this};app.del=deprecate.function(app.delete,"app.del: Use app.delete instead");app.render=function(e,t,n){var r={},i=this.cache,s=this.engines,o;"function"==typeof t&&(n=t,t={});merge(r,this.locals);t._locals&&merge(r,t._locals);merge(r,t);r.cache=null==r.cache?this.enabled("view cache"):r.cache;r.cache&&(o=i[e]);if(!o){o=new(this.get("view"))(e,{defaultEngine:this.get("view engine"),root:this.get("views"),engines:s});if(!o.path){var u=new Error('Failed to lookup view "'+e+'" in views directory "'+o.root+'"');u.view=o;return n(u)}r.cache&&(i[e]=o)}try{o.render(r,n)}catch(u){n(u)}};app.listen=function(){var e=http.createServer(this);return e.listen.apply(e,arguments)};
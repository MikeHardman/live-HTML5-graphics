/*!
 * send
 * Copyright(c) 2012 TJ Holowaychuk
 * Copyright(c) 2014-2015 Douglas Christopher Wilson
 * MIT Licensed
 */"use strict";function send(e,t,n){return new SendStream(e,t,n)}function SendStream(e,t,n){var r=n||{};this.options=r;this.path=t;this.req=e;this._etag=r.etag!==undefined?Boolean(r.etag):!0;this._dotfiles=r.dotfiles!==undefined?r.dotfiles:"ignore";if(this._dotfiles!=="ignore"&&this._dotfiles!=="allow"&&this._dotfiles!=="deny")throw new TypeError('dotfiles option must be "allow", "deny", or "ignore"');this._hidden=Boolean(r.hidden);r.hidden!==undefined&&deprecate("hidden: use dotfiles: '"+(this._hidden?"allow":"ignore")+"' instead");r.dotfiles===undefined&&(this._dotfiles=undefined);this._extensions=r.extensions!==undefined?normalizeList(r.extensions,"extensions option"):[];this._index=r.index!==undefined?normalizeList(r.index,"index option"):["index.html"];this._lastModified=r.lastModified!==undefined?Boolean(r.lastModified):!0;this._maxage=r.maxAge||r.maxage;this._maxage=typeof this._maxage=="string"?ms(this._maxage):Number(this._maxage);this._maxage=isNaN(this._maxage)?0:Math.min(Math.max(0,this._maxage),maxMaxAge);this._root=r.root?resolve(r.root):null;!this._root&&r.from&&this.from(r.from)}function containsDotFile(e){for(var t=0;t<e.length;t++)if(e[t][0]===".")return!0;return!1}function decode(e){try{return decodeURIComponent(e)}catch(t){return-1}}function normalizeList(e,t){var n=[].concat(e||[]);for(var r=0;r<n.length;r++)if(typeof n[r]!="string")throw new TypeError(t+" must be array of strings or false");return n}var createError=require("http-errors"),debug=require("debug")("send"),deprecate=require("depd")("send"),destroy=require("destroy"),escapeHtml=require("escape-html"),parseRange=require("range-parser"),Stream=require("stream"),mime=require("mime"),fresh=require("fresh"),path=require("path"),fs=require("fs"),normalize=path.normalize,join=path.join,etag=require("etag"),EventEmitter=require("events").EventEmitter,ms=require("ms"),onFinished=require("on-finished"),statuses=require("statuses"),extname=path.extname,maxMaxAge=31536e6,resolve=path.resolve,sep=path.sep,toString=Object.prototype.toString,upPathRegexp=/(?:^|[\\\/])\.\.(?:[\\\/]|$)/;module.exports=send;module.exports.mime=mime;var listenerCount=EventEmitter.listenerCount||function(e,t){return e.listeners(t).length};SendStream.prototype.__proto__=Stream.prototype;SendStream.prototype.etag=deprecate.function(function(t){t=Boolean(t);debug("etag %s",t);this._etag=t;return this},"send.etag: pass etag as option");SendStream.prototype.hidden=deprecate.function(function(t){t=Boolean(t);debug("hidden %s",t);this._hidden=t;this._dotfiles=undefined;return this},"send.hidden: use dotfiles option");SendStream.prototype.index=deprecate.function(function e(t){var e=t?normalizeList(t,"paths argument"):[];debug("index %o",t);this._index=e;return this},"send.index: pass index as option");SendStream.prototype.root=function(e){e=String(e);this._root=resolve(e);return this};SendStream.prototype.from=deprecate.function(SendStream.prototype.root,"send.from: pass root as option");SendStream.prototype.root=deprecate.function(SendStream.prototype.root,"send.root: pass root as option");SendStream.prototype.maxage=deprecate.function(function(t){t=typeof t=="string"?ms(t):Number(t);isNaN(t)&&(t=0);Infinity==t&&(t=31536e6);debug("max-age %d",t);this._maxage=t;return this},"send.maxage: pass maxAge as option");SendStream.prototype.error=function t(e,t){if(listenerCount(this,"error")!==0)return this.emit("error",createError(t,e,{expose:!1}));var n=this.res,r=statuses[e];n._headers=null;n.statusCode=e;n.setHeader("Content-Type","text/plain; charset=UTF-8");n.setHeader("Content-Length",Buffer.byteLength(r));n.setHeader("X-Content-Type-Options","nosniff");n.end(r)};SendStream.prototype.hasTrailingSlash=function(){return"/"==this.path[this.path.length-1]};SendStream.prototype.isConditionalGET=function(){return this.req.headers["if-none-match"]||this.req.headers["if-modified-since"]};SendStream.prototype.removeContentHeaderFields=function(){var t=this.res,n=Object.keys(t._headers||{});for(var r=0;r<n.length;r++){var i=n[r];i.substr(0,8)==="content-"&&i!=="content-location"&&t.removeHeader(i)}};SendStream.prototype.notModified=function(){var e=this.res;debug("not modified");this.removeContentHeaderFields();e.statusCode=304;e.end()};SendStream.prototype.headersAlreadySent=function(){var t=new Error("Can't set headers after they are sent.");debug("headers already sent");this.error(500,t)};SendStream.prototype.isCachable=function(){var e=this.res;return e.statusCode>=200&&e.statusCode<300||304==e.statusCode};SendStream.prototype.onStatError=function(t){switch(t.code){case"ENAMETOOLONG":case"ENOENT":case"ENOTDIR":this.error(404,t);break;default:this.error(500,t)}};SendStream.prototype.isFresh=function(){return fresh(this.req.headers,this.res._headers)};SendStream.prototype.isRangeFresh=function(){var t=this.req.headers["if-range"];return t?~t.indexOf('"')?~t.indexOf(this.res._headers.etag):Date.parse(this.res._headers["last-modified"])<=Date.parse(t):!0};SendStream.prototype.redirect=function(t){if(listenerCount(this,"directory")!==0){this.emit("directory");return}if(this.hasTrailingSlash()){this.error(403);return}var n=t+"/",r='Redirecting to <a href="'+escapeHtml(n)+'">'+escapeHtml(n)+"</a>\n",i=this.res;i.statusCode=301;i.setHeader("Content-Type","text/html; charset=UTF-8");i.setHeader("Content-Length",Buffer.byteLength(r));i.setHeader("X-Content-Type-Options","nosniff");i.setHeader("Location",n);i.end(r)};SendStream.prototype.pipe=function(e){var t=this,n=arguments,r=this._root;this.res=e;var i=decode(this.path);if(i===-1)return this.error(400);if(~i.indexOf("\0"))return this.error(400);var s;if(r!==null){if(upPathRegexp.test(normalize("."+sep+i))){debug('malicious path "%s"',i);return this.error(403)}i=normalize(join(r,i));r=normalize(r+sep);s=i.substr(r.length).split(sep)}else{if(upPathRegexp.test(i)){debug('malicious path "%s"',i);return this.error(403)}s=normalize(i).split(sep);i=resolve(i)}if(containsDotFile(s)){var o=this._dotfiles;o===undefined&&(o=s[s.length-1][0]==="."?this._hidden?"allow":"ignore":"allow");debug('%s dotfile "%s"',o,i);switch(o){case"allow":break;case"deny":return this.error(403);case"ignore":default:return this.error(404)}}if(this._index.length&&this.path[this.path.length-1]==="/"){this.sendIndex(i);return e}this.sendFile(i);return e};SendStream.prototype.send=function(e,t){var n=t.size,r=this.options,i={},s=this.res,o=this.req,u=o.headers.range,a=r.start||0;if(s._header)return this.headersAlreadySent();debug('pipe "%s"',e);this.setHeader(e,t);this.type(e);if(this.isConditionalGET()&&this.isCachable()&&this.isFresh())return this.notModified();n=Math.max(0,n-a);if(r.end!==undefined){var f=r.end-a+1;n>f&&(n=f)}if(u){u=parseRange(n,u);if(!this.isRangeFresh()){debug("range stale");u=-2}if(-1==u){debug("range unsatisfiable");s.setHeader("Content-Range","bytes */"+t.size);return this.error(416)}if(-2!=u&&u.length===1){debug("range %j",u);s.statusCode=206;s.setHeader("Content-Range","bytes "+u[0].start+"-"+u[0].end+"/"+n);a+=u[0].start;n=u[0].end-u[0].start+1}}for(var l in r)i[l]=r[l];i.start=a;i.end=Math.max(a,a+n-1);s.setHeader("Content-Length",n);if("HEAD"==o.method)return s.end();this.stream(e,i)};SendStream.prototype.sendFile=function(t){function i(e){if(r._extensions.length<=n)return e?r.onStatError(e):r.error(404);var s=t+"."+r._extensions[n++];debug('stat "%s"',s);fs.stat(s,function(e,t){if(e)return i(e);if(t.isDirectory())return i();r.emit("file",s,t);r.send(s,t)})}var n=0,r=this;debug('stat "%s"',t);fs.stat(t,function(n,s){if(n&&n.code==="ENOENT"&&!extname(t)&&t[t.length-1]!==sep)return i(n);if(n)return r.onStatError(n);if(s.isDirectory())return r.redirect(r.path);r.emit("file",t,s);r.send(t,s)})};SendStream.prototype.sendIndex=function(t){function i(e){if(++n>=r._index.length)return e?r.onStatError(e):r.error(404);var s=join(t,r._index[n]);debug('stat "%s"',s);fs.stat(s,function(e,t){if(e)return i(e);if(t.isDirectory())return i();r.emit("file",s,t);r.send(s,t)})}var n=-1,r=this;i()};SendStream.prototype.stream=function(e,t){var n=!1,r=this,i=this.res,s=this.req,o=fs.createReadStream(e,t);this.emit("stream",o);o.pipe(i);onFinished(i,function(){n=!0;destroy(o)});o.on("error",function(t){if(n)return;n=!0;destroy(o);r.onStatError(t)});o.on("end",function(){r.emit("end")})};SendStream.prototype.type=function(e){var t=this.res;if(t.getHeader("Content-Type"))return;var n=mime.lookup(e),r=mime.charsets.lookup(n);debug("content-type %s",n);t.setHeader("Content-Type",n+(r?"; charset="+r:""))};SendStream.prototype.setHeader=function(t,n){var r=this.res;this.emit("headers",r,t,n);r.getHeader("Accept-Ranges")||r.setHeader("Accept-Ranges","bytes");r.getHeader("Cache-Control")||r.setHeader("Cache-Control","public, max-age="+Math.floor(this._maxage/1e3));if(this._lastModified&&!r.getHeader("Last-Modified")){var i=n.mtime.toUTCString();debug("modified %s",i);r.setHeader("Last-Modified",i)}if(this._etag&&!r.getHeader("ETag")){var s=etag(n);debug("etag %s",s);r.setHeader("ETag",s)}};